<!doctype html>
<html>
    <head>
        <title>Limbo Flimbo</title>
        <meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;"/>
        <style type="text/css"> 

            @font-face {
                font-family: sigoil;
                src: url('assets/Sligoil-Micro copy.otf');
            }

            body {
                background-color:#f0f0f0;
                margin: 0px;
                overflow: hidden;
                font-family: Arial;
            }

            .panel {
                position: absolute;
                padding: 5px;
                border: 1px solid #ddd;
                background-color: white;
                border-radius: 10px;
            }

            .color-selector {
                left: 20px;
                top: 20px;
            }

            .controls {
                left: 20px;
                top: 310px;
            }

            #messages {

                color: #707070;

            }

            #canvas {
                position: absolute;
                top: 0;
                left: 0;
                cursor: crosshair;
            }

            a {
                color: #404040;
                cursor: pointer;
                text-decoration: underline;
            }

            a:hover {
                text-decoration: none;
            }

            .colors {
                display: block;
                width:  40px;
                height: 40px;
                border-radius: 4px;
                border-style: solid;
                border-width: 2px;
                border-color: #ddd;
                margin: 5px;
            }

            .colors.selected {
                border-color: black;
            }

            .modal-dialog {
                display: flex;
                align-items: center;
                justify-content: center;
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(256, 256, 256, 0.5);
            }

            .modal-dialog-content {
                background-color: white;
                padding: 10px;
                border-radius: 10px;
                border: 1px solid #ddd;
            }

            .hidden {
                display: none !important;
            }

            .question-en {
                position: absolute;
                left: 20px;
                top: 5px;
                width: 800px;
                font-size: 38px;
            }

            .question-de {
                position: absolute;
                left: 20px;
                top: 120px;
                width: 800px;
                font-size: 16px;
                font-family: sigoil;
            }

            .button {
                position: absolute;
                cursor: pointer;
            }

            .button:hover {
                background-color: #efefef;
            }

            .brush.button {
                left: 20px;
                top: 450px;
                width: 70px;
                height: 70px;
            }

            .color.button {
                left: 20px;
                top: 550px;
                width: 70px;
                height: 70px;
            }

            .eraser.button {
                left: 20px;
                top: 650px;
                width: 70px;
                height: 70px;
            }

            .ok.button {
                left: 900px;
                top: 690px;
                font-size: 30px;
            }

        </style>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js" type="text/javascript" charset="utf-8"></script>
    </head>
    <body>

        <canvas id="canvas"></canvas>
        <!-- <div class="color-selector panel">
            <div class="colors selected" data-color="0"></div>
            <div class="colors" data-color="1"></div>
            <div class="colors" data-color="2"></div>
            <div class="colors" data-color="3"></div>
            <div class="colors" data-color="4"></div>
        </div> -->

        <div class="question-en">Draw a building you dont like,but you have to enter everyday</div>
        <div class="question-de">Zeichne ein Gebäude welches du nicht magst,du aber täglich betreten musst</div>

        <div class="brush button"><img src="assets/SVGsJohannes_Icons_Brush.svg"/></div>
        <div class="color button"><img src="assets/SVGsJohannes_Icons_ColorBucket.svg"/></div>
        <div class="eraser button"><img src="assets/SVGsJohannes_Icons_Eraser.svg"/></div>

        <div class="ok button" id="doneButton">OK</div>

        <div class="modal-dialog hidden" id="doneDialog">
            <div class="modal-dialog-content">
                Waiting for partner to be done...
            </div>
        </div>

        <div class="modal-dialog hidden" id="printingDialog">
            <div class="modal-dialog-content">
                Printing in progress...
            </div>
        </div>
        
<script src="/socket.io/socket.io.js"></script>
<script type="text/javascript">

    var client = localStorage.client;
    if (!client) window.location.href = '/index.html';

    console.log('This is client ' + client);

    var socket = io.connect();

    var mouseX = 0, mouseY = 0, oldMouseX = 0, oldMouseY = 0, mouseDown = false;

    var colors = ['0,0,0', '255,255,255', '28,83,237', '237,28,36','39,200,7'];

    var CANVAS_WIDTH = 1024;
    var CANVAS_HEIGHT = 768;

    var COLOR = 0;
    var BRUSH = 0;

    var done = false;

    var canvas = document.getElementById( 'canvas' );
    canvas.width = CANVAS_WIDTH;
    canvas.height = CANVAS_HEIGHT;

    var context = canvas.getContext( '2d' );

    function clearCanvas() {
        context.lineWidth = 0.3;
        context.fillStyle = 'rgb(255, 255, 255)';
        context.fillRect( 0, 0, CANVAS_WIDTH, CANVAS_HEIGHT );
    }
    clearCanvas();

    function inputDown(event) {
        mouseDown = true;
        mouseX = event.clientX - canvas.offsetLeft;
        mouseY = event.clientY - canvas.offsetTop;
        socket.emit('draw', { x: mouseX, y: mouseY, color: COLOR });
    }

    function inputUp() {
        mouseDown = false;
    }

    function inputMove(event) {
        oldMouseX = mouseX;
        oldMouseY = mouseY;
        mouseX = event.clientX - canvas.offsetLeft;
        mouseY = event.clientY - canvas.offsetTop;

        if ( mouseDown ) {
            draw( oldMouseX, oldMouseY, mouseX, mouseY, COLOR );
            socket.emit('draw', { x: mouseX, y: mouseY, color: COLOR });
        }
    }

    canvas.addEventListener('mousedown', inputDown);
    canvas.addEventListener('touchstart', function (event) { event.preventDefault(); inputDown(event.touches[0]); });

    window.document.addEventListener('mouseup', inputUp);
    window.document.addEventListener('touchend', inputUp);

    window.document.addEventListener('mousemove', inputMove);
    window.document.addEventListener('touchmove', function (event) { inputMove(event.touches[0]); });

    function remoteDrawHandler(data){
        draw( data.x, data.y, data.x, data.y, data.color );
    }

    socket.on('clear', function () {
        clearCanvas();
    });

    socket.on('close', function(){
        addServerMessage( 'Disconnected :/' );
    });

    socket.on('printing', function (data) {
        console.log('Now printing...', data);
        document.getElementById('doneDialog').classList.add('hidden');
        document.getElementById('printingDialog').classList.remove('hidden');
    });

    socket.on('reset', function (data) {
        console.log('All done, reset state.', data);
        clearCanvas();
        document.getElementById('doneDialog').classList.add('hidden');
        document.getElementById('printingDialog').classList.add('hidden');
        done = false;
    });

    socket.on('draw', remoteDrawHandler);

    socket.on('init', function (data) {
        console.log('init client', data);

        done = data.state[client].done;

        data.strokes.forEach(function (d) {
            remoteDrawHandler(d);
        });
    });

    function draw( x1, y1, x2, y2, color ) {
        var dx  = x2 - x1,
        dy = y2 - y1,
        d = Math.sqrt( dx * dx + dy * dy ) * 0.005;
        
        // // if(d > 0.7) d = 0.7;
        // // context.strokeStyle = ( color == 0 ) ? 'rgba(0, 0, 0, ' + ( 0.7 - d )  + ')' : 'rgba(255, 255, 255, ' + ( 1 - d )  + ')';
        // context.strokeStyle = 'rgba(' + colors[color] +', ' + ( 0.7 - d )  + ')';
        // context.lineWidth = 10.0;
        // context.lineJoin = 'miter';
        // context.beginPath();
        // context.moveTo( x1, y1 );
        // // context.quadraticCurveTo( x2, y2, x1, y1 );
        // context.lineTo( x2, y2 );
        // context.stroke();
        // context.closePath();

        var penSize = 20;
        context.beginPath();
        context.fillStyle = 'rgba(' + colors[color] +', ' + ( 0.7 - d )  + ')';
        context.arc(x2, y2, penSize, 0, Math.PI*2, true);
        context.closePath();
        context.fill();
    }

    document.querySelectorAll('.colors').forEach(function (element) {
        var color = element.getAttribute('data-color');

        element.style.backgroundColor = 'rgba(' + colors[color] +')';

        element.addEventListener('click', function () {
            document.querySelectorAll('.colors').forEach(function (e) { e.classList.remove('selected'); });

            element.classList.add('selected');
            element.style.backgroundColor = 'rgb(' + colors[color] +')';

            COLOR = color;
        });
    });

    // document.getElementById('clearButton').addEventListener('click', function () {
    //     clearCanvas();
    //     socket.emit('clear');
    // });

    document.getElementById('doneButton').addEventListener('click', function () {
        console.log('Now done...');
        document.getElementById('doneDialog').classList.remove('hidden');
        socket.emit('done', { client: client });
    });

</script>



    </body>
</html>
